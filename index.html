<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra Cứu Tiền Điện Tử</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22orange%22%20stroke-width%3D%222%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%2210%22%3E%3C/circle%3E%3Cpath%20d%3D%22M16%208h-6a2%202%200%201%200%200%204h4a2%202%200%201%201%200%204H8%22%3E%3C/path%3E%3Cpath%20d%3D%22M12%204v2%22%3E%3C/path%3E%3Cpath%20d%3D%22M12%2018v2%22%3E%3C/path%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #refreshBtn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* Styles for Modal */
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-container {
            transition: transform 0.2s ease-in-out;
        }
        .price-up {
            color: #16a34a; /* green-600 */
        }
        .price-down {
            color: #dc2626; /* red-600 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-gray-900 dark:text-white">Tra Cứu Tiền Điện Tử</h1>

        <!-- Search Input and Container -->
        <div class="flex items-start space-x-2 max-w-2xl mx-auto">
            <div class="relative flex-grow" id="search-container">
                <div class="relative">
                     <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Nhập tên hoặc ký hiệu (ví dụ: BTC, Bitcoin)" 
                        class="w-full px-4 py-3 pr-10 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 transition-shadow duration-200"
                    >
                    <div id="loading-spinner" class="absolute top-1/2 right-3 transform -translate-y-1/2 hidden">
                        <svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
               
                <!-- Results Dropdown -->
                <div id="results" class="absolute z-10 w-full mt-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg max-h-80 overflow-y-auto hidden">
                    <!-- Results will be injected here -->
                </div>
            </div>
            <button id="refreshBtn" title="Tải dữ liệu mới" class="p-3 bg-blue-500 text-white rounded-lg shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 transition-colors h-[50px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5m7 10v-5h-5m-2-1.5a9 9 0 1111-5.5M4 14.5A9 9 0 0012 20.5c4.142 0 7.6-3 8.5-7"></path>
                </svg>
            </button>
        </div>
        <div id="status-message" class="text-center text-sm text-gray-500 dark:text-gray-400 h-5 mt-2 max-w-2xl mx-auto"></div>

        <!-- Real-time Funding Rate Table -->
        <div class="mt-10 bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-md">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-900 dark:text-white">Bảng Funding Rate Real-time (Binance)</h2>
            <div class="overflow-y-auto max-h-[60vh]">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0">
                        <tr>
                            <th scope="col" class="px-1 py-3">Cặp Giao Dịch</th>
                            <th scope="col" class="px-1 py-3">Thời gian đến lần Funding tiếp theo</th>
                            <th scope="col" class="px-1 py-3 text-right">Tỷ lệ Funding</th>
                        </tr>
                    </thead>
                    <tbody id="funding-rate-table-body">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Percentage Change Calculator -->
        <div class="mt-10 bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-md">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-900 dark:text-white">Công cụ tính toán chênh lệch</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="initialValue" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Giá trị ban đầu V₁</label>
                    <input type="text" id="initialValue" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="0,000">
                </div>
                <div>
                    <label for="finalValue" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Giá trị cuối cùng V₂</label>
                    <input type="text" id="finalValue" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="0,000">
                </div>
                <div>
                    <label for="percentageChange" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phần trăm thay đổi</label>
                    <div class="relative mt-1">
                        <input type="text" id="percentageChange" class="block w-full pl-3 pr-12 py-2 bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm sm:text-sm font-semibold" readonly>
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">%</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="difference" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sự khác biệt</label>
                    <input type="text" id="difference" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm sm:text-sm font-semibold" readonly>
                </div>
                 <div>
                    <label for="leverage" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Đòn bẩy</label>
                    <input type="number" id="leverage" min="0" max="200" value="1" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1">
                </div>
                <div>
                    <label for="profitOrLoss" class="block text-sm font-medium text-gray-700 dark:text-gray-300">% Lãi/Lỗ</label>
                    <div class="relative mt-1">
                        <input type="text" id="profitOrLoss" class="block w-full pl-3 pr-12 py-2 bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm sm:text-sm font-semibold" readonly>
                         <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Exchange Modal -->
    <div id="exchangeModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <!-- Overlay -->
        <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50" id="modalOverlay"></div>
        
        <!-- Modal Content -->
        <div class="modal-container bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] transform scale-95 z-10">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                <h2 id="modalTitle" class="text-xl font-semibold text-gray-900 dark:text-white"></h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="modalBody" class="p-4 overflow-y-auto max-h-[calc(80vh-120px)]">
                <!-- Exchange and Funding Rate data will be loaded here -->
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('results');
        const loadingSpinner = document.getElementById('loading-spinner');
        const searchContainer = document.getElementById('search-container');
        const refreshBtn = document.getElementById('refreshBtn');
        const statusMessage = document.getElementById('status-message');
        const exchangeModal = document.getElementById('exchangeModal');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const fundingRateTableBody = document.getElementById('funding-rate-table-body');
        const initialValueInput = document.getElementById('initialValue');
        const finalValueInput = document.getElementById('finalValue');
        const percentageChangeInput = document.getElementById('percentageChange');
        const differenceInput = document.getElementById('difference');
        const leverageInput = document.getElementById('leverage');
        const profitOrLossInput = document.getElementById('profitOrLoss');


        // API and Constants
        const API_DATA_LIST_URL = 'https://dncapi.flink1.com/api/v2/coin/data_list?webp=1';
        const API_MARKET_TICKER_URL = 'https://dncapi.flink1.com/api/v2/Coin/market_ticker?tickertype=1&webp=1';
        const API_BINANCE_FUNDING_RATE_URL = 'https://fapi.binance.com/fapi/v1/fundingRate';
        const API_BINANCE_PREMIUM_INDEX_URL = 'https://fapi.binance.com/fapi/v1/premiumIndex'; 
        const API_BINANCE_KLINES_URL = 'https://fapi.binance.com/fapi/v1/klines';
        const API_BINANCE_LONG_SHORT_URL = 'https://fapi.binance.com/futures/data/globalLongShortAccountRatio';
        const API_BINANCE_OPEN_INTEREST_URL = 'https://fapi.binance.com/fapi/v1/openInterest';
        const IMAGE_BASE_URL = 'https://s2.flink1.com/cdn-cgi/image/width=40,quality=75/logo/1/';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';

        const CACHE_KEY = 'cryptoApiCache';
        const MAX_RESULTS = 100;
        
        let cryptoData = [];
        
        // --- Data Fetching and Caching ---
        async function refreshData() {
            loadingSpinner.classList.remove('hidden');
            refreshBtn.disabled = true;
            statusMessage.textContent = 'Đang tải dữ liệu mới...';
            try {
                const response = await fetch(API_DATA_LIST_URL);
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.status}`);
                const data = await response.json();

                const processedData = data.data
                    .filter(item => (item[0] || item[1]) && item[3] && item[4] === '1')
                    .map(item => ({
                        code: item[0] || item[1], // Ưu tiên item[0] làm code cho API
                        displayName: item[1],      // Giữ item[1] làm tên hiển thị
                        symbol: item[3],
                        imageUrl: `${IMAGE_BASE_URL}${item[5]}`
                    }));
                
                localStorage.setItem(CACHE_KEY, JSON.stringify(processedData));
                cryptoData = processedData;
                statusMessage.textContent = 'Dữ liệu đã được cập nhật thành công!';
            } catch (error) {
                console.error("Không thể lấy dữ liệu tiền điện tử:", error);
                statusMessage.textContent = 'Lỗi khi cập nhật dữ liệu.';
            } finally {
                setTimeout(() => statusMessage.textContent = '', 3000);
                loadingSpinner.classList.add('hidden');
                refreshBtn.disabled = false;
            }
        }

        // --- Real-time Funding Rate Table Logic ---

        function formatCountdown(ms) {
            if (ms <= 0) return "00:00:00";
            let seconds = Math.floor((ms / 1000) % 60);
            let minutes = Math.floor((ms / (1000 * 60)) % 60);
            let hours = Math.floor((ms / (1000 * 60 * 60)));

            hours = hours.toString().padStart(2, '0');
            minutes = minutes.toString().padStart(2, '0');
            seconds = seconds.toString().padStart(2, '0');

            return `${hours}:${minutes}:${seconds}`;
        }

        function updateCountdownTimers() {
            const timers = fundingRateTableBody.querySelectorAll('.countdown-timer');
            const now = Date.now();
            timers.forEach(timer => {
                const row = timer.closest('tr');
                if (row && row.dataset.nextFundingTime) {
                    const nextTime = parseInt(row.dataset.nextFundingTime, 10);
                    const remaining = nextTime - now;
                    timer.textContent = formatCountdown(remaining);
                }
            });
        }

        function displayGlobalFundingRates(data) {
            fundingRateTableBody.innerHTML = ''; // Clear previous content

            data.forEach(item => {
                const symbolBase = item.symbol.replace('USDT', '');
                const coinInfo = cryptoData.find(c => c.symbol && c.symbol.toUpperCase() === symbolBase);

                const row = document.createElement('tr');
                row.className = 'border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
                row.dataset.nextFundingTime = item.nextFundingTime; // Store for countdown update

                const fundingRate = (parseFloat(item.lastFundingRate) * 100).toFixed(4);
                const rateClass = fundingRate >= 0 ? 'price-up' : 'price-down';
                
                let symbolCellHtml;
                if (coinInfo) {
                    row.dataset.code = coinInfo.code;
                    row.dataset.symbol = coinInfo.symbol;
                    row.dataset.displayName = coinInfo.displayName;
                    symbolCellHtml = `<td class="px-1 py-2 font-semibold text-gray-800 dark:text-gray-200"><a href="#" class="hover:underline cursor-pointer coin-link">${item.symbol}</a></td>`;
                } else {
                    symbolCellHtml = `<td class="px-1 py-2 font-semibold text-gray-800 dark:text-gray-200">${item.symbol}</td>`;
                }

                row.innerHTML = `
                    ${symbolCellHtml}
                    <td class="px-1 py-2 countdown-timer">--:--:--</td>
                    <td class="px-1 py-2 text-right font-semibold ${rateClass}">${fundingRate}%</td>
                `;
                fundingRateTableBody.appendChild(row);
            });
            updateCountdownTimers(); // Initial call to populate timers
        }
        
        async function fetchGlobalFundingRates() {
            if (!fundingRateTableBody.querySelector('.loading-row')) {
                 fundingRateTableBody.innerHTML = `<tr class="loading-row"><td colspan="3" class="text-center p-8"><svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></td></tr>`;
            }
           
            try {
                const response = await fetch(API_BINANCE_PREMIUM_INDEX_URL);
                if (!response.ok) throw new Error('Failed to fetch global funding rates');
                let data = await response.json();

                let usdtPairs = data.filter(p => p.symbol.endsWith('USDT'));
                usdtPairs.sort((a, b) => parseFloat(a.lastFundingRate) - parseFloat(b.lastFundingRate));

                displayGlobalFundingRates(usdtPairs);
            } catch (error) {
                console.error("Error fetching global funding rates:", error);
                fundingRateTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-red-500">Không thể tải dữ liệu funding rate.</td></tr>`;
            }
        }


        async function initializeApp() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            if (cachedData) {
                try {
                    cryptoData = JSON.parse(cachedData);
                    statusMessage.textContent = 'Đã tải dữ liệu từ bộ nhớ đệm.';
                    setTimeout(() => statusMessage.textContent = '', 3000);
                } catch(e) {
                    console.error("Lỗi phân tích dữ liệu cache:", e);
                    await refreshData();
                }
            } else {
                await refreshData();
            }
            
            await fetchGlobalFundingRates();
            setInterval(updateCountdownTimers, 1000);
            setInterval(fetchGlobalFundingRates, 60000); // Refresh data every minute
        }

        // --- Search UI Logic ---
        function displayResults(filteredData) {
            resultsContainer.innerHTML = '';
            const dataToShow = filteredData.slice(0, MAX_RESULTS);

            if (dataToShow.length === 0) {
                resultsContainer.innerHTML = `<div class="p-4 text-center text-gray-500">Không tìm thấy kết quả.</div>`;
            } else {
                dataToShow.forEach(coin => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'flex items-center p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-200 dark:border-gray-700 last:border-b-0';
                    resultItem.dataset.code = coin.code;
                    resultItem.dataset.symbol = coin.symbol;
                    resultItem.dataset.displayName = coin.displayName;
                    
                    resultItem.innerHTML = `
                        <img src="${coin.imageUrl}" alt="${coin.code}" class="w-8 h-8 mr-4 rounded-full" onerror="this.src='https://placehold.co/40x40/e2e8f0/a0aec0?text=?'">
                        <div class="flex-grow">
                            <div class="font-semibold text-gray-800 dark:text-gray-100">${coin.displayName}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${coin.symbol}</div>
                        </div>
                    `;
                    resultsContainer.appendChild(resultItem);
                });

                if (filteredData.length > MAX_RESULTS) {
                    const moreResultsMessage = document.createElement('div');
                    moreResultsMessage.className = 'p-3 text-center text-sm text-gray-500 italic';
                    moreResultsMessage.textContent = `Hiển thị ${MAX_RESULTS} trong số ${filteredData.length} kết quả.`;
                    resultsContainer.appendChild(moreResultsMessage);
                }
            }
            resultsContainer.classList.remove('hidden');
        }

        function debounce(func, delay) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        const handleSearch = () => {
             const query = searchInput.value.trim().toLowerCase();
            if (!query) {
                resultsContainer.classList.add('hidden');
                return;
            }
            const filtered = cryptoData.filter(coin =>
                (coin.displayName && coin.displayName.toLowerCase().includes(query)) ||
                (coin.symbol && coin.symbol.toLowerCase().includes(query)) ||
                (coin.code && coin.code.toLowerCase().includes(query))
            );
            displayResults(filtered);
        };
        
        // --- Modal Logic ---
        function openModal() {
            exchangeModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => {
                exchangeModal.querySelector('.modal-overlay').classList.remove('opacity-0');
                exchangeModal.querySelector('.modal-container').classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            document.body.classList.remove('overflow-hidden');
            exchangeModal.querySelector('.modal-overlay').classList.add('opacity-0');
            exchangeModal.querySelector('.modal-container').classList.add('scale-95');
            setTimeout(() => {
                 exchangeModal.classList.add('hidden');
            }, 200);
        }

        // --- Gemini API ---
        async function getGeminiAnalysis(displayName, binanceSymbol, container) {
            const button = document.getElementById('geminiAnalyzeBtn');
            button.disabled = true;
            container.innerHTML = `<div class="flex justify-center items-center p-4"><svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-2">Đang phân tích dữ liệu...</span></div>`;

            if (!binanceSymbol) {
                 container.innerHTML = `<div class="p-4 text-center text-red-500">Không tìm thấy cặp giao dịch trên Binance để phân tích.</div>`;
                 return;
            }

            // Fetch additional data from Binance
            let dataContext = "Dữ liệu thị trường từ Binance:\n";
            try {
                const [klinesResult, longShortResult, openInterestResult] = await Promise.allSettled([
                    fetch(`${API_BINANCE_KLINES_URL}?symbol=${binanceSymbol}&interval=4h&limit=10`),
                    fetch(`${API_BINANCE_LONG_SHORT_URL}?symbol=${binanceSymbol}&period=4h&limit=1`),
                    fetch(`${API_BINANCE_OPEN_INTEREST_URL}?symbol=${binanceSymbol}`)
                ]);

                if (klinesResult.status === 'fulfilled' && klinesResult.value.ok) {
                    const klines = await klinesResult.value.json();
                    const lastKline = klines[klines.length - 1];
                    dataContext += `- Dữ liệu nến 4h cuối cùng: Mở=${lastKline[1]}, Cao=${lastKline[2]}, Thấp=${lastKline[3]}, Đóng=${lastKline[4]}, Khối lượng=${lastKline[5]}\n`;
                }

                if (longShortResult.status === 'fulfilled' && longShortResult.value.ok) {
                    const ratio = await longShortResult.value.json();
                    if(ratio.length > 0) {
                       dataContext += `- Tỷ lệ Long/Short (4h): ${parseFloat(ratio[0].longShortRatio).toFixed(4)}\n`;
                    }
                }

                if (openInterestResult.status === 'fulfilled' && openInterestResult.value.ok) {
                    const oi = await openInterestResult.value.json();
                    dataContext += `- Khối lượng Hợp đồng Mở (Open Interest): ${parseFloat(oi.openInterest).toLocaleString('en-US')}\n`;
                }

            } catch (e) {
                console.error("Lỗi khi lấy dữ liệu Binance cho Gemini:", e);
                dataContext += " (Không thể lấy một vài dữ liệu phụ từ Binance)\n";
            }


            const userQuery = `Là một chuyên gia phân tích kỹ thuật tiền điện tử, hãy phân tích đồng coin '${displayName}' (${binanceSymbol}).
                Sử dụng các dữ liệu sau đây làm cơ sở chính:
                ${dataContext}

                Dựa vào dữ liệu trên và thông tin thị trường bạn có, hãy cung cấp:
                1.  **Phân tích xu hướng:** Xu hướng chung là gì (tăng, giảm, đi ngang)? Các yếu tố nào (ví dụ: tỷ lệ long/short, khối lượng giao dịch, mô hình nến) đang ủng hộ xu hướng này?
                2.  **Lời khuyên giao dịch (Tham khảo):** Đưa ra một đề xuất giao dịch cho vị thế Long hoặc Short trong ngắn hạn. Bao gồm các mức giá cụ thể cho:
                    - **Entry (Điểm vào lệnh):**
                    - **Take Profit (TP):**
                    - **Stop Loss (SL):**
                3.  **Các yếu tố ảnh hưởng:** Liệt kê ngắn gọn các yếu tố có thể ảnh hưởng đến giá trong thời gian tới.

                **Tuyên bố miễn trừ trách nhiệm:** Luôn thêm dòng chữ "Lưu ý: Phân tích này chỉ mang tính chất tham khảo, không phải là lời khuyên đầu tư chuyên nghiệp." ở cuối cùng.
                Giữ câu trả lời bằng tiếng Việt.`;
            const apiKey = ""; 

            try {
                const response = await fetch(GEMINI_API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        tools: [{ "google_search": {} }],
                    })
                });

                if (!response.ok) {
                     throw new Error(`Gemini API error: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    // Replace markdown bolding with HTML bolding for better display
                    let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900 dark:text-white">$1</strong>');
                    container.innerHTML = `<p class="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-wrap leading-relaxed">${formattedText.replace(/\n/g, '<br>')}</p>`;
                } else {
                    throw new Error("Không nhận được nội dung từ Gemini.");
                }

            } catch(error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                container.innerHTML = `<div class="p-4 text-center text-red-500">Không thể tải phân tích. Vui lòng thử lại.</div>`;
                button.disabled = false;
            }
        }
        
        async function fetchAndDisplayCurrentFundingInfo(symbol, container) {
            container.className = 'mt-6';
            container.innerHTML = `<div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg text-center">Đang tải phí funding hiện tại...</div>`;

            try {
                const params = new URLSearchParams({ symbol: symbol });
                const requestUrl = `${API_BINANCE_PREMIUM_INDEX_URL}?${params.toString()}`;
                const response = await fetch(requestUrl);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.msg || `Binance API Error: ${response.status}`);
                }

                const data = await response.json();
                const currentRate = (parseFloat(data.lastFundingRate) * 100).toFixed(4);
                const nextTime = new Date(data.nextFundingTime).toLocaleString('vi-VN');
                const rateClass = currentRate >= 0 ? 'price-up' : 'price-down';

                container.innerHTML = `
                    <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Thông tin Funding Hiện tại (Binance)</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-500 dark:text-gray-400">Tỷ lệ Funding</p>
                                <p class="font-bold text-xl ${rateClass}">${currentRate}%</p>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-500 dark:text-gray-400">Lần Tiếp theo</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${nextTime}</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error("Lỗi khi lấy thông tin funding hiện tại:", error);
                 container.innerHTML = `<div class="p-4 bg-red-50 dark:bg-red-900/50 rounded-lg text-center text-red-600 dark:text-red-300">Không thể tải thông tin funding hiện tại.</div>`;
            }
        }

        async function fetchAndDisplayFundingRate(symbol, container) {
            container.className = 'mt-4';
            container.innerHTML = `<h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Lịch sử Funding Rate (Binance)</h3><div class="text-center p-4">Đang tải...</div>`;

            try {
                const params = new URLSearchParams({ symbol: symbol, limit: 10 });
                const requestUrl = `${API_BINANCE_FUNDING_RATE_URL}?${params.toString()}`;
                const response = await fetch(requestUrl);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.msg || `Binance API Error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!Array.isArray(result) || result.length === 0) {
                     container.innerHTML = `<h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Lịch sử Funding Rate (Binance)</h3><div class="p-4 text-center text-gray-500">Không tìm thấy dữ liệu.</div>`;
                    return;
                }
                
                const fundingData = result.sort((a, b) => b.fundingTime - a.fundingTime);

                 let tableHtml = `
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="px-1 py-3">Thời gian</th>
                                <th scope="col" class="px-1 py-3 text-right">Tỷ lệ Funding</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                fundingData.forEach(item => {
                    const fundingTime = new Date(item.fundingTime).toLocaleString('vi-VN');
                    const fundingRate = (parseFloat(item.fundingRate) * 100).toFixed(4);

                    tableHtml += `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <td class="px-1 py-2">${fundingTime}</td>
                            <td class="px-1 py-2 text-right font-semibold ${fundingRate >= 0 ? 'price-up' : 'price-down'}">${fundingRate}%</td>
                        </tr>`;
                });

                tableHtml += `</tbody></table>`;
                container.innerHTML = `<h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Lịch sử Funding Rate (Binance)</h3>` + tableHtml;

            } catch(error) {
                console.error("Lỗi khi lấy dữ liệu funding rate:", error);
                container.innerHTML = `<h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Lịch sử Funding Rate (Binance)</h3><div class="p-4 text-center text-red-500">${error.message}</div>`;
            }
        }


        async function fetchAndDisplayExchanges(coinCode, coinSymbol, displayName) {
            modalTitle.textContent = `Sàn Futures cho ${displayName} (${coinSymbol})`;
            
            // Setup Modal HTML with Gemini section
            modalBody.innerHTML = `
                <div id="gemini-analysis-section" class="mb-6 p-4 bg-blue-50 dark:bg-gray-700/50 rounded-lg">
                    <button id="geminiAnalyzeBtn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        ✨ Phân tích Coin này
                    </button>
                    <div id="gemini-analysis-result" class="mt-4"></div>
                </div>
                <div id="exchange-list-section">
                    <div class="flex justify-center items-center p-8">
                        <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>`;
            
            openModal();

            let binanceSymbol = null;
            if (coinSymbol) {
                 binanceSymbol = `${coinSymbol.toUpperCase()}USDT`;
            }

             // Add event listener for the newly created Gemini button
            const geminiBtn = document.getElementById('geminiAnalyzeBtn');
            const geminiResultContainer = document.getElementById('gemini-analysis-result');
            geminiBtn.addEventListener('click', () => getGeminiAnalysis(displayName, binanceSymbol, geminiResultContainer));

            try {
                const response = await fetch(`${API_MARKET_TICKER_URL}&code=${coinCode.toLowerCase()}`);
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.status}`);
                const result = await response.json();
                
                const exchangeListContainer = document.getElementById('exchange-list-section');
                
                if(!result.data || !result.data.markets || result.data.markets.length === 0) {
                     exchangeListContainer.innerHTML = `<div class="p-4 text-center text-gray-500">Không tìm thấy sàn giao dịch Futures nào có cặp USDT.</div>`;
                } else {
                    const allExchanges = result.data.markets;
                    const exchanges = allExchanges.filter(ex => ex.pair2.toUpperCase() === 'USDT');

                    if (exchanges.length === 0) {
                        exchangeListContainer.innerHTML = `<div class="p-4 text-center text-gray-500">Không tìm thấy sàn giao dịch Futures nào có cặp USDT.</div>`;
                    } else {
                        let tableHtml = `
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-1 py-3">#</th>
                                        <th scope="col" class="px-1 py-3">Sàn Giao Dịch</th>
                                        <th scope="col" class="px-1 py-3">Cặp</th>
                                        <th scope="col" class="px-1 py-3 text-right">Giá</th>
                                        <th scope="col" class="px-1 py-3 text-right">Tăng/Giảm 24h</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                        
                        exchanges.forEach((ex, index) => {
                             if(ex.name.toLowerCase() === 'binance' && !binanceSymbol) {
                                binanceSymbol = `${coinSymbol.toUpperCase()}USDT`;
                            }
                            const changeClass = ex.changerate >= 0 ? 'price-up' : 'price-down';
                            const changeSign = ex.changerate >= 0 ? '+' : '';
                            tableHtml += `
                                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <td class="px-1 py-2">${index + 1}</td>
                                    <th scope="row" class="px-1 py-2 font-medium text-gray-900 whitespace-nowrap dark:text-white flex items-center">
                                        <img src="${ex.logo}" alt="${ex.name}" class="w-6 h-6 mr-2 rounded-full">
                                        ${ex.name}
                                    </th>
                                    <td class="px-1 py-2">${ex.pair1}/${ex.pair2}</td>
                                    <td class="px-1 py-2 text-right font-semibold text-gray-800 dark:text-gray-200">${parseFloat(ex.price).toLocaleString('en-US', {minimumFractionDigits: 4})}</td>
                                    <td class="px-1 py-2 text-right font-semibold ${changeClass}">${changeSign}${ex.changerate.toFixed(2)}%</td>
                                </tr>`;
                        });

                        tableHtml += `</tbody></table>`;
                        exchangeListContainer.innerHTML = tableHtml;
                    }
                }
            } catch (error) {
                console.error("Lỗi khi lấy dữ liệu sàn:", error);
                document.getElementById('exchange-list-section').innerHTML = `<div class="p-4 text-center text-red-500">Không thể tải dữ liệu sàn. Vui lòng thử lại.</div>`;
            }

            if (binanceSymbol) {
                const currentFundingContainer = document.createElement('div');
                modalBody.appendChild(currentFundingContainer);
                
                const historicalFundingContainer = document.createElement('div');
                modalBody.appendChild(historicalFundingContainer);

                fetchAndDisplayCurrentFundingInfo(binanceSymbol, currentFundingContainer);
                fetchAndDisplayFundingRate(binanceSymbol, historicalFundingContainer);
            }
        }
        
        // --- Calculator Logic ---
        function calculateDifference() {
            // Replace comma with dot for calculation and parse to float
            const v1 = parseFloat(initialValueInput.value.replace(',', '.'));
            const v2 = parseFloat(finalValueInput.value.replace(',', '.'));
            const leverage = parseFloat(leverageInput.value);

            if (!isNaN(v1) && !isNaN(v2)) {
                const diff = v2 - v1;
                const percentage = (v1 !== 0) ? (diff / v1) * 100 : 0;

                // Format output with comma for decimal point for display
                differenceInput.value = diff.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 8 }).replace(/\./g, ',');
                percentageChangeInput.value = percentage.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 5 }).replace(/\./g, ',');

                if (!isNaN(leverage)) {
                    const profitOrLoss = percentage * leverage;
                    profitOrLossInput.value = profitOrLoss.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 5 }).replace(/\./g, ',');
                } else {
                     profitOrLossInput.value = '';
                }

            } else {
                differenceInput.value = '';
                percentageChangeInput.value = '';
                profitOrLossInput.value = '';
            }
        }


        // --- Event Listeners ---
        searchInput.addEventListener('input', debounce(handleSearch, 250));
        refreshBtn.addEventListener('click', refreshData);
        closeModalBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', closeModal);
        initialValueInput.addEventListener('input', calculateDifference);
        finalValueInput.addEventListener('input', calculateDifference);
        leverageInput.addEventListener('input', calculateDifference);

        searchInput.addEventListener('focus', () => {
             if (searchInput.value.trim()) handleSearch();
        });

        document.addEventListener('click', (event) => {
            if (!searchContainer.contains(event.target) && !refreshBtn.contains(event.target)) {
                resultsContainer.classList.add('hidden');
            }
        });
        
        resultsContainer.addEventListener('click', (event) => {
            const resultItem = event.target.closest('[data-code]');
            if (resultItem) {
                const { code, symbol, displayName } = resultItem.dataset;
                fetchAndDisplayExchanges(code, symbol, displayName);
                resultsContainer.classList.add('hidden');
                searchInput.value = '';
            }
        });

        fundingRateTableBody.addEventListener('click', (event) => {
            const link = event.target.closest('.coin-link');
            if (link) {
                event.preventDefault();
                const row = link.closest('tr');
                if (row && row.dataset.code) {
                    const { code, symbol, displayName } = row.dataset;
                    fetchAndDisplayExchanges(code, symbol, displayName);
                }
            }
        });

        // Initial app load
        initializeApp();
    </script>
</body>
</html>

