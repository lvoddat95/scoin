<!DOCTYPE html>
<html lang="vi" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra Cứu Tiền Điện Tử</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22orange%22%20stroke-width%3D%222%22%3E%3Ccircle%20cx%3D%2212%22%20cy%3D%2212%22%20r%3D%2210%22%3E%3C/circle%3E%3Cpath%20d%3D%22M16%208h-6a2%202%200%201%200%200%204h4a2%202%200%201%201%200%204H8%22%3E%3C/path%3E%3Cpath%20d%3D%22M12%204v2%22%3E%3C/path%3E%3Cpath%20d%3D%22M12%2018v2%22%3E%3C/path%3E%3C/svg%3E">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .price-up {
            color: #198754; /* Bootstrap success color */
        }
        .price-down {
            color: #dc3545; /* Bootstrap danger color */
        }
        .list-group-item-action {
            cursor: pointer;
        }
        .table-responsive {
            max-height: 60vh;
        }
        .clickable-coin {
            cursor: pointer;
            text-decoration: none;
        }
        .clickable-coin:hover {
            text-decoration: underline;
        }
        /* Allow decimals in number input */
        input[type=number] {
         -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
    </style>
</head>
<body class="bg-dark text-light">

    <div class="container my-4 my-md-5">
        <h1 class="text-center mb-4">Tra Cứu Tiền Điện Tử</h1>

        <!-- Search Input and Container -->
        <div class="row justify-content-center">
            <div class="col-lg-8" id="search-container-wrapper">
                <div class="input-group mb-3">
                    <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="Nhập tên hoặc ký hiệu (ví dụ: BTC, Bitcoin)">
                    <button id="refreshBtn" class="btn btn-primary" type="button" title="Tải dữ liệu mới">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                          <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                          <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                        </svg>
                    </button>
                </div>
                 <div id="results" class="list-group position-absolute w-100" style="z-index: 1000; max-width: calc(100% - 24px); display: none;"></div>
                 <div id="status-message" class="text-center text-muted small mt-2" style="height: 1.25rem;"></div>
            </div>
        </div>

        <!-- Real-time Funding Rate Table -->
        <div class="card bg-dark-subtle mt-5">
            <div class="card-header">
                <h2 class="h5 mb-0">Bảng Funding Rate Real-time (Binance)</h2>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th scope="col" class="px-3">Cặp Giao Dịch</th>
                                <th scope="col" class="px-3">TG Funding Tiếp</th> 
                                <th scope="col" class="text-end px-3">Tỷ lệ Funding</th>
                            </tr>
                        </thead>
                        <tbody id="funding-rate-table-body">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Percentage Change Calculator -->
        <div class="card bg-dark-subtle mt-5">
             <div class="card-header">
                <h2 class="h5 mb-0">Công cụ tính toán chênh lệch</h2>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="initialValue" class="form-label">Giá trị ban đầu V₁</label>
                        <input type="number" step="any" id="initialValue" class="form-control" placeholder="0,000"> 
                    </div>
                    <div class="col-md-6">
                        <label for="finalValue" class="form-label">Giá trị cuối cùng V₂</label>
                        <input type="number" step="any" id="finalValue" class="form-control" placeholder="0,000"> 
                    </div>
                     <div class="col-md-6">
                        <label for="leverage" class="form-label">Đòn bẩy</label>
                        <input type="number" id="leverage" min="0" max="200" value="1" class="form-control" placeholder="1">
                    </div>
                     <div class="col-md-6">
                        <label for="profitOrLoss" class="form-label">% Lãi/Lỗ</label>
                        <div class="input-group">
                            <input type="text" id="profitOrLoss" class="form-control" readonly>
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="percentageChange" class="form-label">Phần trăm thay đổi</label>
                        <div class="input-group">
                            <input type="text" id="percentageChange" class="form-control" readonly>
                             <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="difference" class="form-label">Sự khác biệt</label>
                        <input type="text" id="difference" class="form-control" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exchange Modal -->
    <div class="modal fade" id="exchangeModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h5 class="modal-title" id="modalTitle"></h5>
              <div id="current-price-section" class="text-muted small"></div> 
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="modalBody">
            <!-- Content will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // API and Constants
        const API_DATA_LIST_URL = 'https://dncapi.flink1.com/api/v2/coin/data_list?webp=1';
        const API_MARKET_TICKER_URL = 'https://dncapi.flink1.com/api/v2/Coin/market_ticker?tickertype=1&webp=1';
        const API_BINANCE_FUNDING_RATE_URL = 'https://fapi.binance.com/fapi/v1/fundingRate';
        const API_BINANCE_PREMIUM_INDEX_URL = 'https://fapi.binance.com/fapi/v1/premiumIndex'; 
        const API_BINANCE_KLINES_URL = 'https://fapi.binance.com/fapi/v1/klines';
        const API_BINANCE_LONG_SHORT_URL = 'https://fapi.binance.com/futures/data/globalLongShortAccountRatio';
        const API_BINANCE_OPEN_INTEREST_URL = 'https://fapi.binance.com/fapi/v1/openInterest';
        const API_BINANCE_TICKER_PRICE_URL = 'https://fapi.binance.com/fapi/v1/ticker/price'; // Added Binance price API
        const IMAGE_BASE_URL = 'https://s2.flink1.com/cdn-cgi/image/width=40,quality=75/logo/1/';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';

        const CACHE_KEY = 'cryptoApiCache';
        const MAX_RESULTS = 100;
        
        let cryptoData = [];
        let exchangeModal; // Defined globally to be accessible

        // --- Data Fetching and Caching ---
        async function refreshData() {
            $('#refreshBtn').prop('disabled', true);
            $('#status-message').text('Đang tải dữ liệu mới...');
            try {
                const data = await $.getJSON(API_DATA_LIST_URL);
                const processedData = data.data
                    .filter(item => (item[0] || item[1]) && item[3] && item[4] === '1')
                    .map(item => ({
                        code: item[0] || item[1],
                        displayName: item[1],
                        symbol: item[3],
                        imageUrl: `${IMAGE_BASE_URL}${item[5]}`
                    }));
                localStorage.setItem(CACHE_KEY, JSON.stringify(processedData));
                cryptoData = processedData;
                $('#status-message').text('Dữ liệu đã được cập nhật thành công!');
            } catch (error) {
                console.error("Không thể lấy dữ liệu tiền điện tử:", error);
                $('#status-message').text('Lỗi khi cập nhật dữ liệu.');
            } finally {
                setTimeout(() => $('#status-message').text(''), 3000);
                $('#refreshBtn').prop('disabled', false);
            }
        }
        
        // --- Real-time Funding Rate Table ---
        function formatCountdown(ms) {
            if (ms <= 0) return "00:00:00";
            let seconds = Math.floor((ms / 1000) % 60).toString().padStart(2, '0');
            let minutes = Math.floor((ms / (1000 * 60)) % 60).toString().padStart(2, '0');
            let hours = Math.floor((ms / (1000 * 60 * 60))).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function updateCountdownTimers() {
            const now = Date.now();
            $('#funding-rate-table-body tr').each(function() {
                const nextTime = $(this).data('next-funding-time');
                if (nextTime) {
                    const remaining = nextTime - now;
                    $(this).find('.countdown-timer').text(formatCountdown(remaining));
                }
            });
        }

        async function fetchGlobalFundingRates() {
            if ($('#funding-rate-table-body .loading-row').length === 0) {
                 $('#funding-rate-table-body').html(`<tr class="loading-row"><td colspan="3" class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>`);
            }
            try {
                let data = await $.getJSON(API_BINANCE_PREMIUM_INDEX_URL);
                let usdtPairs = data.filter(p => p.symbol.endsWith('USDT'));
                usdtPairs.sort((a, b) => parseFloat(a.lastFundingRate) - parseFloat(b.lastFundingRate));
                
                $('#funding-rate-table-body').empty();
                usdtPairs.forEach(item => {
                    const symbolBase = item.symbol.replace('USDT', '');
                    const coinInfo = cryptoData.find(c => c.symbol && c.symbol.toUpperCase() === symbolBase);
                    const fundingRate = (parseFloat(item.lastFundingRate) * 100).toFixed(4);
                    const rateClass = fundingRate >= 0 ? 'price-up' : 'price-down';

                    const $row = $('<tr>').data('next-funding-time', item.nextFundingTime);
                    let symbolCell;

                    if(coinInfo){
                        // Prepare data for the onclick attribute
                        const code = coinInfo.code.replace(/'/g, "\\'"); // Escape single quotes
                        const symbol = coinInfo.symbol.replace(/'/g, "\\'");
                        const displayName = coinInfo.displayName.replace(/'/g, "\\'");
                        
                        symbolCell = $(`<td class="px-3 clickable-coin" onclick="fetchAndDisplayExchanges('${code}', '${symbol}', '${displayName}')">`).text(item.symbol);
                    } else {
                        symbolCell = $('<td class="px-3">').text(item.symbol);
                    }
                    
                    $row.append(symbolCell);
                    $row.append($('<td class="countdown-timer px-3">').text('--:--:--'));
                    $row.append($(`<td class="text-end fw-bold px-3 ${rateClass}">`).text(`${fundingRate}%`));

                    $('#funding-rate-table-body').append($row);
                });
                updateCountdownTimers();
            } catch (error) {
                console.error("Error fetching global funding rates:", error);
                $('#funding-rate-table-body').html(`<tr><td colspan="3" class="text-center p-4 text-danger">Không thể tải dữ liệu funding rate.</td></tr>`);
            }
        }

        // --- Gemini API ---
        async function getGeminiAnalysis(displayName, binanceSymbol, container) {
            const button = $('#geminiAnalyzeBtn');
            button.prop('disabled', true);
            container.html(`<div class="d-flex justify-content-center align-items-center p-3"><div class="spinner-border text-primary" role="status"></div><span class="ms-2">Đang phân tích dữ liệu...</span></div>`);

            if (!binanceSymbol) {
                container.html(`<div class="p-3 text-center text-danger">Không tìm thấy cặp giao dịch trên Binance để phân tích.</div>`);
                return;
            }

            let dataContext = "Dữ liệu kỹ thuật từ Binance:\n";
            try {
                const [klinesData, longShortData, openInterestData] = await Promise.all([
                    $.getJSON(`${API_BINANCE_KLINES_URL}?symbol=${binanceSymbol}&interval=4h&limit=10`),
                    $.getJSON(`${API_BINANCE_LONG_SHORT_URL}?symbol=${binanceSymbol}&period=4h&limit=1`),
                    $.getJSON(`${API_BINANCE_OPEN_INTEREST_URL}?symbol=${binanceSymbol}`)
                ]);

                if (klinesData && klinesData.length > 0) {
                    const lastKline = klinesData[klinesData.length - 1];
                    dataContext += `- Dữ liệu nến 4h cuối cùng: Mở=${lastKline[1]}, Cao=${lastKline[2]}, Thấp=${lastKline[3]}, Đóng=${lastKline[4]}, Khối lượng=${lastKline[5]}\n`;
                }
                if (longShortData && longShortData.length > 0) {
                    dataContext += `- Tỷ lệ Long/Short (4h): ${parseFloat(longShortData[0].longShortRatio).toFixed(4)}\n`;
                }
                if (openInterestData) {
                    dataContext += `- Khối lượng Hợp đồng Mở (Open Interest): ${parseFloat(openInterestData.openInterest).toLocaleString('en-US')}\n`;
                }
            } catch (e) {
                 console.error("Lỗi khi lấy dữ liệu Binance cho Gemini:", e);
                 dataContext += " (Không thể lấy một vài dữ liệu phụ từ Binance)\n";
            }

            const userQuery = `Là một chuyên gia phân tích thị trường tài chính, hãy phân tích toàn diện về đồng coin '${displayName}' (${binanceSymbol}) để đưa ra lời khuyên giao dịch ngắn hạn.
            
            **Phân tích dựa trên các yếu tố sau:**
            
            1.  **Dữ liệu Kỹ thuật (cung cấp):**
                ${dataContext}
            
            2.  **Tâm lý Thị trường Chung (tự tìm kiếm):** Xu hướng hiện tại của Bitcoin và các altcoin lớn đang ảnh hưởng thế nào? Thị trường đang trong giai đoạn "tham lam" hay "sợ hãi"?
            
            3.  **Bối cảnh Kinh tế Vĩ mô (tự tìm kiếm):** Có tin tức nào gần đây về lạm phát, quyết định lãi suất của FED, hoặc các sự kiện kinh tế toàn cầu có thể tác động đến thị trường tiền điện tử không?
            
            **Yêu cầu đầu ra:**
            
            * **Tổng hợp Phân tích:** Đưa ra một nhận định ngắn gọn về xu hướng chính của đồng coin dựa trên sự kết hợp của cả 3 yếu tố trên.
            * **Lời khuyên Giao dịch (Tham khảo):** Dựa trên phân tích tổng hợp, đề xuất một vị thế (Long hoặc Short) với các mức giá cụ thể:
                * **Entry (Vùng vào lệnh):**
                * **Take Profit (TP):**
                * **Stop Loss (SL):**
            * **Lý do:** Giải thích ngắn gọn tại sao lại đưa ra đề xuất đó.
            
            **Tuyên bố miễn trừ trách nhiệm:** Luôn thêm dòng chữ "Lưu ý: Phân tích này chỉ mang tính chất tham khảo, không phải là lời khuyên đầu tư chuyên nghiệp." ở cuối cùng.
            Giữ câu trả lời bằng tiếng Việt.`;
            const apiKey = "AIzaSyB-a2SJULSailN2v0KAcncutoBSpDlsJvM"; 

            try {
                const response = await fetch(GEMINI_API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        tools: [{ "google_search": {} }],
                    })
                });
                if (!response.ok) throw new Error(`Gemini API error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    container.html(`<p class="small">${formattedText}</p>`);
                } else {
                    throw new Error("Không nhận được nội dung từ Gemini.");
                }
            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                container.html(`<div class="p-3 text-center text-danger">Không thể tải phân tích. Vui lòng thử lại.</div>`);
                button.prop('disabled', false);
            }
        }
        
        // --- Modal Exchanges and Funding ---
        // Make this function global so it can be called from onclick
        window.fetchAndDisplayExchanges = async function(coinCode, coinSymbol, displayName) {
            $('#modalTitle').text(`Sàn Futures cho ${displayName} (${coinSymbol})`);
            const modalBody = $('#modalBody');
            const currentPriceContainer = $('#current-price-section'); // Get price container reference
            currentPriceContainer.html('<span class="placeholder col-3"></span>'); // Add placeholder while loading

            // Clear previous modal content except title and price placeholder
            modalBody.html(`
                <div class="mb-4 p-3 bg-primary-subtle border border-primary-subtle rounded-3">
                    <button id="geminiAnalyzeBtn" class="btn btn-primary w-100">✨ Phân tích Coin này</button>
                    <div id="gemini-analysis-result" class="mt-3"></div>
                </div>
                <div id="exchange-list-section"><div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div></div>
            `);
            exchangeModal.show();
            
            let binanceSymbol = coinSymbol ? `${coinSymbol.toUpperCase()}USDT` : null;

            // Fetch Binance Ticker Price *first*
            if (binanceSymbol) {
                try {
                    const priceData = await $.getJSON(`${API_BINANCE_TICKER_PRICE_URL}?symbol=${binanceSymbol}`);
                    const currentPrice = parseFloat(priceData.price);
                    currentPriceContainer.html(`<span class="h5 fw-bold">${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 4})}</span> <span class="text-muted">USDT (Binance)</span>`);
                } catch(e) {
                    console.error("Lỗi khi lấy giá Binance:", e);
                    currentPriceContainer.html('<span class="text-danger small">Không tải được giá Binance</span>');
                }
            } else {
                 currentPriceContainer.empty(); // Clear if no binance symbol
            }


            // Use .off().on() to prevent multiple bindings if modal is reopened
            $('#geminiAnalyzeBtn').off('click').on('click', function() {
                getGeminiAnalysis(displayName, binanceSymbol, $('#gemini-analysis-result'));
            });

            try {
                const result = await $.getJSON(`${API_MARKET_TICKER_URL}&code=${coinCode.toLowerCase()}`);
                const exchangeListContainer = $('#exchange-list-section');
                
                if (!result.data || !result.data.markets || result.data.markets.length === 0) {
                    exchangeListContainer.html(`<div class="p-3 text-center text-muted">Không tìm thấy sàn giao dịch Futures nào có cặp USDT.</div>`);
                   
                } else {
                     const exchanges = result.data.markets.filter(ex => ex.pair2.toUpperCase() === 'USDT');
                     if (exchanges.length === 0) {
                        exchangeListContainer.html(`<div class="p-3 text-center text-muted">Không tìm thấy sàn giao dịch Futures nào có cặp USDT.</div>`);
                        
                     } else {
                         const table = $('<table class="table table-dark table-hover">');
                         table.html(`
                            <thead><tr>
                                <th scope="col">#</th><th scope="col">Sàn</th><th scope="col">Cặp</th>
                                <th scope="col" class="text-end">Giá</th><th scope="col" class="text-end">24h %</th>
                            </tr></thead>
                         `);
                         const tbody = $('<tbody>');
                         exchanges.forEach((ex, index) => {
                             const changeClass = ex.changerate >= 0 ? 'price-up' : 'price-down';
                             const changeSign = ex.changerate >= 0 ? '+' : '';
                             tbody.append(`
                                <tr>
                                    <td>${index + 1}</td>
                                    <td><img src="${ex.logo}" class="rounded-circle me-2" width="24" height="24">${ex.name}</td>
                                    <td>${ex.pair1}/${ex.pair2}</td>
                                    <td class="text-end fw-bold">${parseFloat(ex.price).toLocaleString('en-US', {minimumFractionDigits: 4})}</td>
                                    <td class="text-end fw-bold ${changeClass}">${changeSign}${ex.changerate.toFixed(2)}%</td>
                                </tr>
                             `);
                         });
                         table.append(tbody);
                         exchangeListContainer.html(table);
                     }
                }
            } catch (error) {
                console.error("Lỗi khi lấy dữ liệu sàn:", error);
                 $('#exchange-list-section').html(`<div class="p-3 text-center text-danger">Không thể tải dữ liệu sàn.</div>`);
            } 

            if (binanceSymbol) {
                // Placeholder for funding sections
                modalBody.append('<div id="current-funding-section" class="mt-4"></div>');
                modalBody.append('<div id="historical-funding-section" class="mt-4"></div>');

                // Fetch and display funding info
                try {
                    const fundingInfo = await $.getJSON(`${API_BINANCE_PREMIUM_INDEX_URL}?symbol=${binanceSymbol}`);
                    const currentRate = (parseFloat(fundingInfo.lastFundingRate) * 100).toFixed(4);
                    const nextTime = new Date(fundingInfo.nextFundingTime).toLocaleString('vi-VN');
                    const rateClass = currentRate >= 0 ? 'price-up' : 'price-down';
                    $('#current-funding-section').html(`
                        <div class="card bg-dark-subtle">
                            <div class="card-body">
                                <h6 class="card-title">Thông tin Funding Hiện tại (Binance)</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="small text-muted">Tỷ lệ Funding</div>
                                        <div class="h4 fw-bold ${rateClass}">${currentRate}%</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="small text-muted">Lần Tiếp theo</div>
                                        <div>${nextTime}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                } catch (e) {
                     $('#current-funding-section').html(`<div class="p-3 text-center text-danger small">Không thể tải thông tin funding hiện tại.</div>`);
                }
                
                try {
                    const fundingHistory = await $.getJSON(`${API_BINANCE_FUNDING_RATE_URL}?symbol=${binanceSymbol}&limit=10`);
                    const historyTable = $('<table class="table table-dark table-sm mt-3">');
                    historyTable.html(`
                        <thead><tr>
                            <th>Thời gian</th><th class="text-end">Tỷ lệ</th>
                        </tr></thead>
                    `);
                    const historyBody = $('<tbody>');
                    fundingHistory.sort((a,b) => b.fundingTime - a.fundingTime).forEach(item => {
                         const fundingRate = (parseFloat(item.fundingRate) * 100).toFixed(4);
                         const rateClass = fundingRate >= 0 ? 'price-up' : 'price-down';
                         historyBody.append(`
                            <tr>
                                <td>${new Date(item.fundingTime).toLocaleString('vi-VN')}</td>
                                <td class="text-end fw-bold ${rateClass}">${fundingRate}%</td>
                            </tr>
                         `);
                    });
                    historyTable.append(historyBody);
                    $('#historical-funding-section').html('<h6 class="mt-4">Lịch sử Funding Rate (Binance)</h6>').append(historyTable);

                } catch(e) {
                    $('#historical-funding-section').html(`<div class="p-3 text-center text-danger small">Không thể tải lịch sử funding rate.</div>`);
                }
            }
        }

        // --- Calculator Logic ---
        function calculateDifference() {
            // Use parseFloat directly on number input value
            const v1 = parseFloat($('#initialValue').val()); 
            const v2 = parseFloat($('#finalValue').val());
            const leverage = parseFloat($('#leverage').val());

            if (!isNaN(v1) && !isNaN(v2)) {
                const diff = v2 - v1;
                const percentage = (v1 !== 0) ? (diff / v1) * 100 : 0;

                // Format output with comma for decimal point for display
                $('#difference').val(diff.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 8 }).replace(/\./g, ','));
                $('#percentageChange').val(percentage.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 5 }).replace(/\./g, ','));

                if (!isNaN(leverage)) {
                    const profitOrLoss = percentage * leverage;
                    $('#profitOrLoss').val(profitOrLoss.toLocaleString('vi-VN', { minimumFractionDigits: 2, maximumFractionDigits: 5 }).replace(/\./g, ','));
                } else {
                     $('#profitOrLoss').val('');
                }

            } else {
                $('#difference, #percentageChange, #profitOrLoss').val('');
            }
        }


        // --- Event Listeners ---
        $('#refreshBtn').on('click', refreshData);
        $('#initialValue, #finalValue, #leverage').on('input', calculateDifference);

        let searchTimeout;
        $('#searchInput').on('input', function() {
            clearTimeout(searchTimeout);
            const $results = $('#results').empty().show();
            // Adjust width based on the input group, not just the input
            $results.css('max-width', $('#searchInput').closest('.input-group').outerWidth()); 

            searchTimeout = setTimeout(() => {
                const query = $(this).val().trim().toLowerCase();
                if (!query) {
                    $results.hide();
                    return;
                }
                const filtered = cryptoData.filter(coin =>
                    (coin.displayName && coin.displayName.toLowerCase().includes(query)) ||
                    (coin.symbol && coin.symbol.toLowerCase().includes(query)) ||
                    (coin.code && coin.code.toLowerCase().includes(query))
                );
                
                if(filtered.length === 0){
                    $results.append('<div class="list-group-item">Không tìm thấy kết quả.</div>');
                    return;
                }
                filtered.slice(0, MAX_RESULTS).forEach(coin => {
                    const $item = $(`
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center">
                            <img src="${coin.imageUrl}" class="rounded-circle me-3" width="32" height="32" onerror="this.src='https://placehold.co/32x32/868e96/dee2e6?text=?'">
                            <div>
                                <div class="fw-bold">${coin.displayName}</div>
                                <div class="small text-muted">${coin.symbol}</div>
                            </div>
                        </a>
                    `);
                    $item.data('coin', coin);
                    $results.append($item);
                });

                 if (filtered.length > MAX_RESULTS) {
                    $results.append(`<div class="list-group-item text-center small text-muted fst-italic">Hiển thị ${MAX_RESULTS} kết quả...</div>`);
                 }

            }, 250);
        });

        $('#results').on('click', '.list-group-item-action', function(e){
            e.preventDefault();
            const coin = $(this).data('coin');
            fetchAndDisplayExchanges(coin.code, coin.symbol, coin.displayName);
            $('#results').hide();
            $('#searchInput').val('');
        });
        
        // Removed the separate listener as it's now handled by onclick in the TD

        $(document).on('click', function(e) {
            // Updated selector to target the wrapper div
            if (!$(e.target).closest('#search-container-wrapper').length) {
                $('#results').hide();
            }
        });

        // --- Initial App Load ---
        async function init() {
            exchangeModal = new bootstrap.Modal(document.getElementById('exchangeModal')); // Initialize modal here
            const cachedData = localStorage.getItem(CACHE_KEY);
            if (cachedData) {
                try {
                    cryptoData = JSON.parse(cachedData);
                    $('#status-message').text('Đã tải dữ liệu từ bộ nhớ đệm.');
                     setTimeout(() => $('#status-message').text(''), 3000);
                } catch (e) { await refreshData(); }
            } else {
                await refreshData();
            }
            await fetchGlobalFundingRates();
            setInterval(updateCountdownTimers, 1000);
            setInterval(fetchGlobalFundingRates, 60000);
        }
        
        init();
    </script>

</body>
</html>

